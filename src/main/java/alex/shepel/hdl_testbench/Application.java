package alex.shepel.hdl_testbench;

import alex.shepel.hdl_testbench.backend.Backend;
import alex.shepel.hdl_testbench.frontend.Frontend;
import alex.shepel.hdl_testbench.frontend.widgets.PresetButton;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.IOException;

/*
 * File: Application.java
 * -----------------------------------------------
 * Program that generate test environment
 * for the specified FPGA design file.
 * See the link below.
 *
 * TODO: Link to the help file.
 *       Also it can be great to use autogenerated
 *       java-doc.
 */
public class Application implements ActionListener {

    /* Main objects.
    Backend contains app's logic.
    Frontend contains app's GUI. */
    private static Frontend frontend;
    private static Backend backend;

    /**
     * The class constructor.
     */
    public Application() {
        /* Initializes Frontend object. */
        frontend = new Frontend();

        /* Adds action listeners
        to the control buttons of the app's window. */
        for (PresetButton butt: Frontend.getButtonsMap().values())
            butt.addActionListener(this);

        /* Initializes Backend object. */
        try {
            backend = new Backend();
        }

        /* Shows error message on the app's window.
        In this case backend initialization is unsuccessful
        because some of internal files are absent or can't be read. */
        catch (IOException e) {
            e.printStackTrace();
            frontend.showExceptionMessage(e);
        }
    }

    /**
     * Implements the ActionListener interface.
     *
     * @param e The ActionEvent object.
     *          Contains an action
     *          that just happened
     *          on the app's window.
     */
    @Override
    public void actionPerformed(ActionEvent e) {
        switch (e.getActionCommand()) {
            case "< Back" ->
                    frontend.back();
            case "Next >" -> {
                if (doBackendAction())
                    frontend.next();
            }
            case "Help" ->
                    frontend.help();
            case "Finish" ->
                    frontend.finish();
        }
    }

    /**
     * -- Checks configuration page that is shown
     * on the app's window at the moment.
     * -- Runs backend actions that correspond to that page.
     * -- Catches exceptions and shows warning messages.
     *
     * @return "true" when backend action is successfully completed.
     */
    private boolean doBackendAction() {
        try {
            switch (frontend.getPageName()) {
                case "Specify DUT file" ->
                    backend.setDutFile(frontend.getDutFile());
                case "Specify working folder" -> {
                    backend.setWorkingFolder(frontend.getWorkingFolder());
                    frontend.setDutClocks(backend.getDutClocks());
                    frontend.refresh();
                }
                case "Specify clocks" ->
                    backend.setClocksHashMap(frontend.getClocksHashMap());
                case "Specify sampling frequency" -> {
                    backend.setReportSamplingFrequency(frontend.getReportSamplingFrequency());
                    backend.generateEnvironment();
                }
                default -> {
                    return false;
                }
            }
            return true;
        }

        catch (Exception e) {
            frontend.showExceptionMessage(e);
            e.printStackTrace();
            return false;
        }
    }
}
